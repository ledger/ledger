name: clang-format

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v6

      - name: Install clang-format
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y clang-format-18

      - name: Check formatting
        run: |
          find src \( -name '*.h' -o -name '*.cc' \) | sort | xargs clang-format-18 -i
          if ! git diff --exit-code; then
            echo ""
            echo "========================================="
            echo "Formatting changes detected. Run 'make reformat' to fix."
            exit 1
          fi
          echo "All files are properly formatted!"
